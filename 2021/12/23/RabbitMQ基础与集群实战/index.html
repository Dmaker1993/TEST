<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="RabbitMQ基础与集群实战"><meta name="keywords" content="RabbitMQ,中间件,集群"><meta name="author" content="secret"><meta name="copyright" content="secret"><title>RabbitMQ基础与集群实战 | 一名不愿透露姓名的程序员</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E5%AE%9E%E6%88%98%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ实战教程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MQ%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">1.MQ引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 什么是MQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-MQ%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 MQ有哪些</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%8D%E5%90%8CMQ%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 不同MQ的特点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RabbitMQ%E7%9A%84%E5%BC%95%E8%A8%80"><span class="toc-number">1.2.</span> <span class="toc-text">2.RabbitMQ的引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-RabbitMQ%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 RabbitMQ简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-RabbitMQ%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 RabbitMQ的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-erlang%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.2.1 erlang下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-RabbitMQ%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2.2.2 RabbitMQ下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">2.2.3 安装启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-RabbitMQ%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">3.RabbitMQ配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-RabbitMQ%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 RabbitMQ管理命令行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-web%E7%AE%A1%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 web管理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1%E7%94%A8%E6%88%B7%E5%92%8C%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">3.2.1用户和虚拟主机管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-1-%E7%94%A8%E6%88%B7"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">3.2.1.1 用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-2-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">3.2.1.2 虚拟主机</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-3-%E7%94%A8%E6%88%B7%E5%92%8C%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E7%BB%91%E5%AE%9A"><span class="toc-number">1.3.2.1.3.</span> <span class="toc-text">3.2.1.3 用户和虚拟主机绑定</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-RabbitMQ%E7%9A%84Java%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.</span> <span class="toc-text">4.RabbitMQ的Java客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-AMQP%E5%8D%8F%E8%AE%AE%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 AMQP协议回顾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-RabbitMQ%E6%94%AF%E6%8C%81%E7%9A%84%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 RabbitMQ支持的消息类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%90%84%E7%A7%8D%E6%A8%A1%E5%9E%8B%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 各种模型客户端代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-Direct-%E7%9B%B4%E8%BF%9E%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">4.4.1 Direct-直连模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-Work-Queues-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">4.4.2 Work Queues-工作队列</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-2-1-%E6%B6%88%E6%81%AF%E8%87%AA%E5%8A%A8%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.4.2.1.</span> <span class="toc-text">4.4.2.1 消息自动确认机制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3-Publish-Subscribe-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">4.4.3 Publish&#x2F;Subscribe-发布订阅模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-4-Routing-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">4.4.4 Routing-路由模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-5-Topics-%E4%B8%BB%E9%A2%98%EF%BC%88%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">1.4.4.5.</span> <span class="toc-text">4.4.5 Topics-主题（动态路由模式）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-SpringBoot%E9%87%8D%E4%BD%BF%E7%94%A8RabbitMQ"><span class="toc-number">1.5.</span> <span class="toc-text">5.SpringBoot重使用RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 搭建环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">5.1.1 引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">5.1.2 配置信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%90%84%E7%A7%8D%E6%A8%A1%E5%9E%8B%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 各种模型客户端代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-Hello-World-%E7%9B%B4%E8%BF%9E%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">5.2.1 Hello World-直连模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-Work-Queue-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">5.2.2 Work Queue - 工作队列模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-Publish-Subscribe-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">5.2.3 Publish&#x2F;Subscribe - 发布订阅模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-Routing-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F%EF%BC%88direct%EF%BC%89"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">5.2.4 Routing - 路由模式（direct）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-5-Topics-%E4%B8%BB%E9%A2%98%EF%BC%88%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%EF%BC%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">5.2.5 Topics - 主题（动态路由）模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-6-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">5.2.6 客户端测试代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-MQ%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.6.</span> <span class="toc-text">6.MQ的应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 异步处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%BA%94%E7%94%A8%E8%A7%A3%E8%97%95"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 应用解藕</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 流量削峰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-RabbitMQ%E9%9B%86%E7%BE%A4"><span class="toc-number">1.7.</span> <span class="toc-text">7.RabbitMQ集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%EF%BC%88%E5%89%AF%E6%9C%AC%E9%9B%86%E7%BE%A4%EF%BC%89"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 集群架构（副本集群）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">7.1.1 架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-2-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">7.1.2 集群搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 镜像集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">7.2.1 架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">7.2.2 集群搭建</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">secret</div><div class="author-info__description text-center">不被定义</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">1</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">一名不愿透露姓名的程序员</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">归档</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">RabbitMQ基础与集群实战</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-12-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="RabbitMQ实战教程"><a href="#RabbitMQ实战教程" class="headerlink" title="RabbitMQ实战教程"></a>RabbitMQ实战教程</h1><blockquote>
<p>视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1dE411K7MG?from=search&amp;seid=15593601763323732951&amp;spm_id_from=333.337.0.0">https://www.bilibili.com/video/BV1dE411K7MG?from=search&amp;seid=15593601763323732951&amp;spm_id_from=333.337.0.0</a></p>
</blockquote>
<h2 id="1-MQ引言"><a href="#1-MQ引言" class="headerlink" title="1.MQ引言"></a>1.MQ引言</h2><h3 id="1-1-什么是MQ"><a href="#1-1-什么是MQ" class="headerlink" title="1.1 什么是MQ"></a>1.1 什么是MQ</h3><p>​        <code>MQ</code>(Message Queue)：翻译为<code>消息队列</code>，通过典型的<code>生产者</code>和<code>消费者</code>模型，生产者不断向消息队列中生产消息，消费者不断从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的消费和生产，没有业务逻辑的侵入，轻松的实现系统间的解藕。别名为：<code>消息中间件</code>，通过利用高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成。</p>
<h3 id="1-2-MQ有哪些"><a href="#1-2-MQ有哪些" class="headerlink" title="1.2 MQ有哪些"></a>1.2 MQ有哪些</h3><p>​        当今市面上有很多的消息中间件，如老牌的<code>ActiveMQ</code>，<code>RabbitMQ</code>，炙手可热的<code>Kafka</code>、阿里巴巴自主研发的<code>RocketMQ</code>等。</p>
<h3 id="1-3-不同MQ的特点"><a href="#1-3-不同MQ的特点" class="headerlink" title="1.3 不同MQ的特点"></a>1.3 不同MQ的特点</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.ActiveMQ</span></span><br><span class="line"><span class="code">	ActiveMQ是Apache出品，最流行的，能力强劲的开源消息总线。他是一个完全支持JMS规范的消息中间件。丰富的API，多种集群架构模式让ActiveMQ称为老牌的消息中间件，在中小企业颇受欢迎。</span></span><br><span class="line"><span class="code"># 2.Kafka</span></span><br><span class="line"><span class="code">	Kafka是LinkedIn公司开源的分布式发布-订阅消息中间件，目前属于Apache顶级项目。Kafka的主要特点是基于pull模式来处理消息消费。追求高吞吐量，一开始的目的是用于日志的收集和传输。0.8版本开始支持复制，不支持事物，对消息的丢失、重复、错误没有严格的要求。适合产生大量数据的互联网服务的数据收集业务。</span></span><br><span class="line"><span class="code"># 3.RocketMQ</span></span><br><span class="line"><span class="code">	RocketMQ是阿里开源的消息中间件。他是纯java开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。RocketMQ的思路起源于Kafka，但并不是Kafka的一个复制，他对消息的可靠传输及事物做了优化，目前的阿里集团被广泛应用于交易、充值、流计算、消息推送、日志流处理、binglog分发等场景。</span></span><br><span class="line"><span class="code"># 4.RabbitMQ</span></span><br><span class="line"><span class="code">	RabbitMQ是使用Erlang语言开发的开源消息中间件系统，基于AMQP协议来实现。AMQP的主要特征是面向消息、队列、路由（包括点对点和发布订阅）、可靠性、安全。AMQP协议更多用在企业内对数据一致性、稳定性和可靠性要求很高的场景，对性能和吞吐量的要求还在其次。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>RabbitMQ比Kafka可靠，Kafka更适合IO高吞吐的处理，一般应用在大数据日志处理或对实时性（延时低）、可靠性（少量丢数据）要求稍低的场景使用，比如ELK日志收集。</p>
</blockquote>
<h2 id="2-RabbitMQ的引言"><a href="#2-RabbitMQ的引言" class="headerlink" title="2.RabbitMQ的引言"></a>2.RabbitMQ的引言</h2><h3 id="2-1-RabbitMQ简介"><a href="#2-1-RabbitMQ简介" class="headerlink" title="2.1 RabbitMQ简介"></a>2.1 RabbitMQ简介</h3><p>​        RabbitMQ是基于AMQP协议，erlang语言开发，是部署最广泛的开源消息中间件，也是最受欢迎的消息中间件之一。</p>
<p><img src="https://img-blog.csdnimg.cn/681db2b5bf6f486f8dfa258fa90aad53.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># AMQP协议（后续单独讲）</span></span><br><span class="line"><span class="code">	AMQP(Advanced Message Queuing Protocol，高级消息队列协议)，在2003年被提出，在最用于解决金融领域不同平台之间消息传递的交互问题。顾名思义，AMQP是一种协议，更准确的说是一种binary wrie-level protocol（链接协议）。这时其和JMS的本质差异，AMQP不从api层进行限定，而是直接定义网络交换的数据格式。这使得实现了AMQP的provider天然性就是跨平台的。</span></span><br><span class="line"><span class="code">								Server</span></span><br><span class="line"><span class="code">					+---------------------------+</span></span><br><span class="line"><span class="code">					|		Virtual Host		|</span></span><br><span class="line"><span class="code">					|	+--------------------+  |</span></span><br><span class="line"><span class="code">   	+------------+  |	|	+-----------+    |	|</span></span><br><span class="line"><span class="code">	| Publisher  | --------&gt;| Exchange	|    |  |</span></span><br><span class="line"><span class="code">	| Application|	|	|	+-----+-----+    |  |</span></span><br><span class="line"><span class="code">	+------------+	|   | 		  |			 |	|</span></span><br><span class="line"><span class="code">					|	|	+-----------+	 |	|	+-------------+</span></span><br><span class="line"><span class="code">					|	|	+  Message	+	 |	|	|  Consummer  |</span></span><br><span class="line"><span class="code">					|	|	+	Queue	+ ---------&gt;| Application |</span></span><br><span class="line"><span class="code">					|	|	+-----------+	 |	|	+-------------+</span></span><br><span class="line"><span class="code">					|	+--------------------+	|</span></span><br><span class="line"><span class="code">					+---------------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-RabbitMQ的安装"><a href="#2-2-RabbitMQ的安装" class="headerlink" title="2.2 RabbitMQ的安装"></a>2.2 RabbitMQ的安装</h3><p>​        本次安装的环境如下：</p>
<ul>
<li>系统：centos8 64位</li>
<li>erlang：24.1.7</li>
<li>rabbitmq：3.9.11</li>
</ul>
<h4 id="2-2-1-erlang下载"><a href="#2-2-1-erlang下载" class="headerlink" title="2.2.1 erlang下载"></a>2.2.1 erlang下载</h4><blockquote>
<p>因为rabbitMQ是基于erlang开发的，所以先要下载erlang的包：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/erlang-rpm">https://github.com/rabbitmq/erlang-rpm</a></p>
<p>erlang版本和rabbitmq版本对照：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">https://www.rabbitmq.com/which-erlang.html</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/bf7aa8f5462148a99f279b03dcb493d1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="iamge"></p>
<p>​        本次开发使用的最新的rabbitmq版本为<code>3.9.11</code>，最小支持的erlang版本为23.2，所以本次erlang使用了<code>24.1.7</code>版本</p>
<p><img src="https://img-blog.csdnimg.cn/889a43dfbe3048b58c0622101762bbad.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="iamge"></p>
<h4 id="2-2-2-RabbitMQ下载"><a href="#2-2-2-RabbitMQ下载" class="headerlink" title="2.2.2 RabbitMQ下载"></a>2.2.2 RabbitMQ下载</h4><blockquote>
<p>rabbitmq下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-rpm.html#downloads">https://www.rabbitmq.com/install-rpm.html#downloads</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/40404dec0e524d10bb9df1a1d16f9b5d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h4 id="2-2-3-安装启动"><a href="#2-2-3-安装启动" class="headerlink" title="2.2.3 安装启动"></a>2.2.3 安装启动</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.将rabbitmq相关包上传到linxu服务器中</span></span><br><span class="line"><span class="code">	使用scp命令上传到服务器两个包：</span></span><br><span class="line"><span class="code">	scp ./erlang-24.1.7-1.el8.x86_64.rpm root@10.3.4.5:/root/</span></span><br><span class="line"><span class="code">	scp ./rabbitmq-server-3.9.11-1.el8.noarch.rpm root@10.3.4.5:/root/</span></span><br><span class="line"><span class="code"># 2.依次安装erlang、rabbitmq</span></span><br><span class="line"><span class="code">	使用rpm命令进行安装，缺少依赖会进行提示：</span></span><br><span class="line"><span class="code">	rpm -ivh erlang-24.1.7-1.el8.x86_64.rpm</span></span><br><span class="line"><span class="code">	rpm -ivn rabbitmq-server-3.9.11-1.el8.noarch.rpm</span></span><br><span class="line"><span class="code"># 3.修改rabbitmq的配置</span></span><br><span class="line"><span class="code">	使用rpm包的方式安装时，并没有将配置文件也放到指定目录下，所以需要自行创建一个配置文件：/etc/rabbitmq/rabbitmq.conf，具体的配置内容可以参考：https://www.rabbitmq.com/configure.html#config-file-formats。</span></span><br><span class="line"><span class="code">	这里我们需要修改一处：loopback_users=none，表示能够让guest用户进行远程访问。默认情况下，guest用户只能在localhost域名下访问。我们使用的是云服务器，需要使用ip进行访问，所以需要修改这个配置。</span></span><br><span class="line"><span class="code"># 4.开启管理控制台插件</span></span><br><span class="line"><span class="code">	其实就是开启rabbitmq的一个插件：rabbitmq_management，可以让我们使用web界面管理rabbitmq。执行命令：rabbitmq-plugins enable rabbitmq_management。该命令还另外开启了2个插件：rabbitmq_management_agent、rabbitmq_web_dispatch。</span></span><br><span class="line"><span class="code"># 5.启动/停止/重启rabbitmq服务</span></span><br><span class="line"><span class="code">	rabbitmq安装的时候，会将其设置为系统服务，使用系统服务命令即可：</span></span><br><span class="line"><span class="code">	systemctl start/stop/restart rabbitmq-server.service</span></span><br><span class="line"><span class="code"># 6.查看服务状态</span></span><br><span class="line"><span class="code">	systemctl stauts rabbitmq-server.service</span></span><br><span class="line"><span class="code">    结果如下为正常运行中：</span></span><br><span class="line"><span class="code">    ● rabbitmq-server.service - RabbitMQ broker</span></span><br><span class="line"><span class="code">       Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled; vendor preset: disabled)</span></span><br><span class="line"><span class="code">       Active: active (running) since Sun 2021-12-12 23:56:51 CST; 1 day 9h ago</span></span><br><span class="line"><span class="code">      Process: 22710 ExecStop=/usr/sbin/rabbitmqctl shutdown (code=exited, status=0/SUCCESS)</span></span><br><span class="line"><span class="code">     Main PID: 22758 (beam.smp)</span></span><br><span class="line"><span class="code">        Tasks: 23 (limit: 23722)</span></span><br><span class="line"><span class="code">       Memory: 94.8M</span></span><br><span class="line"><span class="code">       CGroup: /system.slice/rabbitmq-server.service</span></span><br><span class="line"><span class="code">               ├─22758 /usr/lib64/erlang/erts-12.1.5/bin/beam.smp -W w -MBas ageffcbf -MHas ageffcbf -MBlmbcs 512 -MHlmbcs 512 -MMmcs 30 -P 1048576 -t 5000000 -stbt db -zdbbl 12800&gt;</span></span><br><span class="line"><span class="code">               ├─22773 erl_child_setup 32768</span></span><br><span class="line"><span class="code">               ├─22827 inet_gethost 4</span></span><br><span class="line"><span class="code">               └─22828 inet_gethost 4</span></span><br><span class="line"><span class="code"># 7.访问管理界面</span></span><br><span class="line"><span class="code"> 	默认http后台界面的端口为15672。</span></span><br><span class="line"><span class="code"> 	http://10.3.4.5:15672/</span></span><br><span class="line"><span class="code"># 8.登陆</span></span><br><span class="line"><span class="code">	账号/密码：guest/guest</span></span><br></pre></td></tr></table></figure>

<h2 id="3-RabbitMQ配置"><a href="#3-RabbitMQ配置" class="headerlink" title="3.RabbitMQ配置"></a>3.RabbitMQ配置</h2><h3 id="3-1-RabbitMQ管理命令行"><a href="#3-1-RabbitMQ管理命令行" class="headerlink" title="3.1 RabbitMQ管理命令行"></a>3.1 RabbitMQ管理命令行</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.服务管理</span></span><br><span class="line"><span class="code">	systemctl start/stop/restart rabbitmq-server.service</span></span><br><span class="line"><span class="code"># 2.管理命令行</span></span><br><span class="line"><span class="code">	可以用来在不使用web管理端的情况下管理rabbitmq。</span></span><br><span class="line"><span class="code">	rabbitmqctl help // 查看所有的命令</span></span><br><span class="line"><span class="code"># 3.插件管理</span></span><br><span class="line"><span class="code">	rabbitmq-plugins enable/list/disable</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-web管理介绍"><a href="#3-2-web管理介绍" class="headerlink" title="3.2 web管理介绍"></a>3.2 web管理介绍</h3><p><img src="https://img-blog.csdnimg.cn/6a2017fe4a3a4216a594f1d64c3a28e6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<ul>
<li><strong>Connection</strong>：连接，无论是消费者还是生产者，都要与rabbitmq建立连接才能进行消息的生产与消费。</li>
<li><strong>Channels</strong>：通道，建立连接后，消息的投递和获取都是通过通道来进行的。</li>
<li><strong>Exchages</strong>：交换机，用来实现消息的路有。</li>
<li><strong>Queues</strong>：队列，消息存放于该队列中，等待消费，消费之后移除。</li>
</ul>
<h4 id="3-2-1用户和虚拟主机管理"><a href="#3-2-1用户和虚拟主机管理" class="headerlink" title="3.2.1用户和虚拟主机管理"></a>3.2.1用户和虚拟主机管理</h4><h5 id="3-2-1-1-用户"><a href="#3-2-1-1-用户" class="headerlink" title="3.2.1.1 用户"></a>3.2.1.1 用户</h5><p><img src="https://img-blog.csdnimg.cn/67b980ab25e24c75b2a6d3c9590c22ff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Tags说明：</span></span><br><span class="line"><span class="code">	Admin(超级管理员)：登录控制台，查看所有信息，并对用户、策略（policy）进行修改。</span></span><br><span class="line"><span class="code">	Monitoring（监控者）：登陆控制台，查看rabbitmq的节点（进程数、内存、磁盘等使用情况）信息。</span></span><br><span class="line"><span class="code">	Policymaker（策略制定者）：登陆控制台，对policy进行管理。</span></span><br><span class="line"><span class="code">	Management（普通管理员）：登陆控制台查看信息。</span></span><br><span class="line"><span class="code">	其他：无法登陆控制台，就是普通的消费者或者生产者。</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-1-2-虚拟主机"><a href="#3-2-1-2-虚拟主机" class="headerlink" title="3.2.1.2 虚拟主机"></a>3.2.1.2 虚拟主机</h5><p><img src="https://img-blog.csdnimg.cn/b21620fc59f5467ebc4c0402d5e2c0df.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 虚拟主机：</span></span><br><span class="line"><span class="code">	为了让各个用户可以互不干扰的工作，RabbitMQ添加了虚拟主机（Virtual Host）概念。其实就是一个独立的访问路径，不同用户使用不同路径，各自都有自己的队列、交换机，互不影响。相当于MySQL中的数据库。</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-1-3-用户和虚拟主机绑定"><a href="#3-2-1-3-用户和虚拟主机绑定" class="headerlink" title="3.2.1.3 用户和虚拟主机绑定"></a>3.2.1.3 用户和虚拟主机绑定</h5><p><img src="https://img-blog.csdnimg.cn/e60681b36bec47b5bba1ebde7ee8d03b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<p><img src="https://img-blog.csdnimg.cn/b4808afbd6e34a8e982624a3f0b02856.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h2 id="4-RabbitMQ的Java客户端"><a href="#4-RabbitMQ的Java客户端" class="headerlink" title="4.RabbitMQ的Java客户端"></a>4.RabbitMQ的Java客户端</h2><h3 id="4-1-AMQP协议回顾"><a href="#4-1-AMQP协议回顾" class="headerlink" title="4.1 AMQP协议回顾"></a>4.1 AMQP协议回顾</h3><p><img src="https://img-blog.csdnimg.cn/eb827e01a84b4eea9bddb6dab2947c84.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h3 id="4-2-RabbitMQ支持的消息类型"><a href="#4-2-RabbitMQ支持的消息类型" class="headerlink" title="4.2 RabbitMQ支持的消息类型"></a>4.2 RabbitMQ支持的消息类型</h3><p><img src="https://img-blog.csdnimg.cn/40d40399960442e9a2d0d5668a6825d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h3 id="4-3-引入依赖"><a href="#4-3-引入依赖" class="headerlink" title="4.3 引入依赖"></a>4.3 引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.14.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-各种模型客户端代码"><a href="#4-4-各种模型客户端代码" class="headerlink" title="4.4 各种模型客户端代码"></a>4.4 各种模型客户端代码</h3><h4 id="4-4-1-Direct-直连模式"><a href="#4-4-1-Direct-直连模式" class="headerlink" title="4.4.1 Direct-直连模式"></a>4.4.1 Direct-直连模式</h4><p><img src="https://img-blog.csdnimg.cn/2401e687d01347fb9827dffb97b570c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_18,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 相关概念：</span></span><br><span class="line"><span class="code">	P：provider，生产者，要发送消息的程序</span></span><br><span class="line"><span class="code">	C：consumer，消费者，消费消息的程序</span></span><br><span class="line"><span class="code">	Queue：队列，存储消息的地方</span></span><br></pre></td></tr></table></figure>

<p><strong>Producer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * direct模式-生产者</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 直接点对点，也就是生产者将消息发送到队列中，消费者直接从队列中获取</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 11:34 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProducer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义队列名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;101.43.52.186&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/adu&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.创建通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.声明队列：队列名称，是否持久化，是否独占，额外参数</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 5.向队列发送消息：交换机名称，队列名称，额外参数，消息体</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="keyword">null</span>, <span class="string">&quot;hello world&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">// 6.关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Consumer</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * direct模式-消费者</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 11:34 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// 1 创建连接工厂，并设置基础参数</span></span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;101.43.52.186&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/adu&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">        <span class="comment">// 2 创建连接</span></span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3 创建通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 4 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 4 接收消息</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 回调方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer：&quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 5 关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-Work-Queues-工作队列"><a href="#4-4-2-Work-Queues-工作队列" class="headerlink" title="4.4.2 Work Queues-工作队列"></a>4.4.2 Work Queues-工作队列</h4><p><img src="https://img-blog.csdnimg.cn/37c7326912a04ff1baaa25754a61535f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<p>​        Work Queue也被称为<code>Task Queue</code>任务模型。当消息处理比较耗时时，可能消息生产的速度远远超过了消息消费的速度。长此以往，消息就会堆积，此时就可以使用Work Queue模型。让多个消费者绑定同一个队列，共同消费队列中的消息。队列中的消息一旦被消费，就会被删除，因此不会产生重复消费。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提取连接rabbitmq的工具类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span>    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建连接工厂</span></span><br><span class="line">            ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            <span class="comment">// 设置参数</span></span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;101.43.52.186&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/adu&quot;</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;adu&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title">getChannel</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> connection.createChannel();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Channel channel, Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Producer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Work Queue模型</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 工作队列模型，应对的是消费者消费比较慢的情况，多个消费者共同消费同一个队列中的消息。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 2:02 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueueProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;work&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 发消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="keyword">null</span>, (<span class="string">&quot;hello work queue &quot;</span> + i).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        RabbitMQUtil.close(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Consumer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consumer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueueConsumer1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;work&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取管道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumer2</span></span><br><span class="line">和consumer1相同代码，修改消费输出：System.out.println(<span class="string">&quot;consumer2: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># consumer1 output...</span></span><br><span class="line">consumer1: hello work queue 0</span><br><span class="line">consumer1: hello work queue 2</span><br><span class="line">consumer1: hello work queue 4</span><br><span class="line">consumer1: hello work queue 6</span><br><span class="line">consumer1: hello work queue 8</span><br><span class="line"><span class="section"># consumer2 output...</span></span><br><span class="line">consumer2: hello work queue 1</span><br><span class="line">consumer2: hello work queue 3</span><br><span class="line">consumer2: hello work queue 5</span><br><span class="line">consumer2: hello work queue 7</span><br><span class="line">consumer2: hello work queue 9</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>​        默认情况下，RabbitMQ将按顺序依次将消息发给每个消费者，也就是说每个消费者都会收到相同数量的消息，这种平分消息的方式称为<code>循环</code>。</p>
<h5 id="4-4-2-1-消息自动确认机制"><a href="#4-4-2-1-消息自动确认机制" class="headerlink" title="4.4.2.1 消息自动确认机制"></a>4.4.2.1 消息自动确认机制</h5><p>​        如果一个消费者在执行任务的过程中宕机，那么在以上代码中，一旦RabbitMQ将将消息传递给消费者，他就会立即标记为删除，那么该消费者中未处理的消息将丢失。我们希望在处理任务的过程中，一个消费者宕机了，能够将任务交给其他消费者处理。这时候我们就可以用到<code>消息自动确认机制</code>。也就是说，我们可以在处理完任务之后，再通知RabbitMQ可以删除该任务。</p>
<p><strong>Producer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同上</span></span><br></pre></td></tr></table></figure>

<p><strong>Consumer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consumer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueueConsumer3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;work&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取管道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 每次只能消费一个消息</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟处理消息消耗时常</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">                <span class="comment">// 手动确认，参数1：消息标记 参数2：是否同时确认多条，false表示每次只能确认一条</span></span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// consumer2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueueConsumer4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;work&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取管道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 限制每次消费1条</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 消费消息，autoAck改为false，表示不自动确认</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">                <span class="comment">// 手动确认</span></span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># consumer1 output...</span></span><br><span class="line">consumer1: hello work queue 1</span><br><span class="line">consumer1: hello work queue 3</span><br><span class="line">consumer1: hello work queue 5</span><br><span class="line">consumer1: hello work queue 8</span><br><span class="line">consumer1: hello work queue 10</span><br><span class="line">consumer1: hello work queue 13</span><br><span class="line">consumer1: hello work queue 15</span><br><span class="line">consumer1: hello work queue 18</span><br><span class="line"><span class="section"># consumer2 output...</span></span><br><span class="line">consumer1: hello work queue 0</span><br><span class="line">consumer1: hello work queue 2</span><br><span class="line">consumer1: hello work queue 4</span><br><span class="line">consumer1: hello work queue 6</span><br><span class="line">consumer1: hello work queue 7</span><br><span class="line">consumer1: hello work queue 9</span><br><span class="line">consumer1: hello work queue 11</span><br><span class="line">consumer1: hello work queue 12</span><br><span class="line">consumer1: hello work queue 14</span><br><span class="line">consumer1: hello work queue 16</span><br><span class="line">consumer1: hello work queue 17</span><br><span class="line">consumer1: hello work queue 19</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>​        实现消息自动确认，需要注意两点：1）设置通道一次只能消费一条消息 2）关闭自动确认，手动确认消息</p>
<h4 id="4-4-3-Publish-Subscribe-发布订阅模式"><a href="#4-4-3-Publish-Subscribe-发布订阅模式" class="headerlink" title="4.4.3 Publish/Subscribe-发布订阅模式"></a>4.4.3 Publish/Subscribe-发布订阅模式</h4><p><img src="https://img-blog.csdnimg.cn/610277d029c04fe5a3933cf79f21dcc2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 消息流程：</span></span><br><span class="line"><span class="code">	可以有多个消费者，每个消费者都有自己的queue（队列），每个队列都要绑定要exchange（交换机）。</span></span><br><span class="line"><span class="code">	生产者发送的消息只能发送给交换机，交换机来决定发送给哪个队列，生产者无法决定。</span></span><br><span class="line"><span class="code">	交换机把消息发送给绑定过的所有队列，队列的消费者都能拿到消息，实现一个消息被多个消费者消费。</span></span><br><span class="line"><span class="code"># 对应交换机类型：fanout</span></span><br></pre></td></tr></table></figure>

<p><strong>Proudcer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublishSubscriptProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">&quot;fanout&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明交换机 交换机名称 交换机类型</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送消息到交换机</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;logs&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;hello fanout&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        RabbitMQUtil.close(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Consumer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consumer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublishSubscribeConsumer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建临时队列</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 绑定交换机和队列 队列名称 交换机名称 路由</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumer2</span></span><br><span class="line">同consumer1，输出修改为：System.out.println(<span class="string">&quot;consumer2: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># consumer1 output...</span></span><br><span class="line">consumer1: hello fanout, type [</span><br><span class="line">consumer1: hello fanout</span><br><span class="line"></span><br><span class="line"><span class="section"># consumer2 output...</span></span><br><span class="line">consumer2: hello fanout, type [</span><br><span class="line">consumer2: hello fanout</span><br></pre></td></tr></table></figure>

<h4 id="4-4-4-Routing-路由模式"><a href="#4-4-4-Routing-路由模式" class="headerlink" title="4.4.4 Routing-路由模式"></a>4.4.4 Routing-路由模式</h4><p>​        在发布订阅模式中，一条消息会被所有订阅的的队列消费。但是在某些场景下，我们希望不同的消息类型被不同的队列消费，这时就需要用到Routing模式的direct类型的Exchange。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 在Direct模式下：</span></span><br><span class="line"><span class="code">	队列与交换机的绑定，不能是任意绑定了，而是需要指定一个Routing Keying，消息发送方在向Exchange发送消息时，也必须指定消息的Routing Key。</span></span><br><span class="line"><span class="code">	Exchange也不再把消息交给每一个与之绑定的队列，而是根据消息的Routing Key判断，只有队列的Routing Key和消息的Routing Key完全一致时，才会发送消息。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/8f206f2cfdb34ce89c54e042a92cc21f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 说明：</span></span><br><span class="line"><span class="code">	P：Proudcer，生产者，向Exchange发送消息，同时会指定一个Routing Key。</span></span><br><span class="line"><span class="code">	X：Exchange，交换机，接收生产者发送的消息，然后把消息传递给与routing key完全匹配的队列。</span></span><br><span class="line"><span class="code">	C1：Consumer，消费者，其所在队列指定了需要routing key为error的消息</span></span><br><span class="line"><span class="code">	C2：Consumer，消费者，其所在队列指定了需要routing key为info、error、warning的消息</span></span><br></pre></td></tr></table></figure>

<p><strong>Producer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取管道</span></span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        <span class="comment">// 声明交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        String routingKey = <span class="string">&quot;warning&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;logs_direct&quot;</span>, routingKey, <span class="keyword">null</span>, String.format(<span class="string">&quot;routing for type [%s]&quot;</span>, routingKey).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        RabbitMQUtil.close(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Consumer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consumer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingConsumer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// consumer1绑定routing key 为info</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumer2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingConsumer2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// consumer1绑定routing key 为info、error、warning</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;logs_direct&quot;</span>, <span class="string">&quot;warning&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer2: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 依次发送routing key为info、error、warning结果：</span></span><br><span class="line"></span><br><span class="line"><span class="section">## consummer1</span></span><br><span class="line">consumer1: routing for type [info]</span><br><span class="line"></span><br><span class="line"><span class="section">## consumer2</span></span><br><span class="line">consumer1: routing for type [info]</span><br><span class="line">consumer1: routing for type [error]</span><br><span class="line">consumer1: routing for type [warning]</span><br></pre></td></tr></table></figure>

<h4 id="4-4-5-Topics-主题（动态路由模式）"><a href="#4-4-5-Topics-主题（动态路由模式）" class="headerlink" title="4.4.5 Topics-主题（动态路由模式）"></a>4.4.5 Topics-主题（动态路由模式）</h4><p>​        <code>Topics</code>模式同<code>Routing</code>模式相比，都可以根据Routing Key把消息路由到不同的队列。只不过<code>Topic</code>类型的Routing Key可以使用通配符。Routing Key一般是由一个或多个单词组成，多个单词之间以‘,’分割。Exchange的类型为<code>topic</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/e1252695c8fd433e9885d1a9e8c4e9fb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 通配符：</span></span><br><span class="line"><span class="code">	*（star）can substitute for exactly one word。精确匹配一个单词。</span></span><br><span class="line"><span class="code">	#（hash）can substitute for zero or more words。匹配零个、一个或多个单词。</span></span><br><span class="line"><span class="code">## 例如：</span></span><br><span class="line"><span class="code">	audit.# ：匹配 audit、audit.irs、audit.irs.corporate 等。</span></span><br><span class="line"><span class="code">	audit.* ：只能匹配 audit.irs。</span></span><br></pre></td></tr></table></figure>

<p><strong>Producer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicsProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs_topics&quot;</span>, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        String routingKey = <span class="string">&quot;user.save.now&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;logs_topics&quot;</span>, routingKey, <span class="keyword">null</span>, String.format(<span class="string">&quot;hello topics, routing key : [%s]&quot;</span>, routingKey).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        RabbitMQUtil.close(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Consumer：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consumer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicsConsumer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">&quot;logs_topics&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 队列和交换机绑定的路由为 user.*</span></span><br><span class="line">        channel.queueBind(queue, EXCHANGE_NAME, <span class="string">&quot;user.*&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer1: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumer2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicsConsumer2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">&quot;logs_topics&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = RabbitMQUtil.getChannel(connection);</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 队列和交换机绑定的路由为 user.*</span></span><br><span class="line">        channel.queueBind(queue, EXCHANGE_NAME, <span class="string">&quot;user.#&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer2: &quot;</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 依次发送routing key为user.save、user、user.save.now的结果：</span></span><br><span class="line"></span><br><span class="line"><span class="section">## conumser1:</span></span><br><span class="line">consumer1: hello topics, routing key : [user.save]</span><br><span class="line"></span><br><span class="line"><span class="section">## consumer2:</span></span><br><span class="line">consumer2: hello topics, routing key : [user.save]</span><br><span class="line">consumer2: hello topics, routing key : [user]</span><br><span class="line">consumer2: hello topics, routing key : [user.save.now]</span><br></pre></td></tr></table></figure>

<h2 id="5-SpringBoot重使用RabbitMQ"><a href="#5-SpringBoot重使用RabbitMQ" class="headerlink" title="5.SpringBoot重使用RabbitMQ"></a>5.SpringBoot重使用RabbitMQ</h2><h3 id="5-1-搭建环境"><a href="#5-1-搭建环境" class="headerlink" title="5.1 搭建环境"></a>5.1 搭建环境</h3><h4 id="5-1-1-引入依赖"><a href="#5-1-1-引入依赖" class="headerlink" title="5.1.1 引入依赖"></a>5.1.1 引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-配置信息"><a href="#5-1-2-配置信息" class="headerlink" title="5.1.2 配置信息"></a>5.1.2 配置信息</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">adu-rabbitmq</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">10.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">adu</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">adu</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/adu</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-各种模型客户端代码"><a href="#5-2-各种模型客户端代码" class="headerlink" title="5.2 各种模型客户端代码"></a>5.2 各种模型客户端代码</h3><h4 id="5-2-1-Hello-World-直连模型"><a href="#5-2-1-Hello-World-直连模型" class="headerlink" title="5.2.1 Hello World-直连模型"></a>5.2.1 Hello World-直连模型</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * direct直连模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 6:30 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;hello&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-Work-Queue-工作队列模式"><a href="#5-2-2-Work-Queue-工作队列模式" class="headerlink" title="5.2.2 Work Queue - 工作队列模式"></a>5.2.2 Work Queue - 工作队列模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Work Queue模式-消费者</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 循环模式，每个消费者得到的消息数相同</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 6:36 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueueConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;work&quot;, durable = &quot;true&quot;, exclusive = &quot;false&quot;, autoDelete = &quot;false&quot;))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer1: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;work&quot;, durable = &quot;true&quot;, exclusive = &quot;false&quot;, autoDelete = &quot;false&quot;))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer2: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-Publish-Subscribe-发布订阅模式"><a href="#5-2-3-Publish-Subscribe-发布订阅模式" class="headerlink" title="5.2.3 Publish/Subscribe - 发布订阅模式"></a>5.2.3 Publish/Subscribe - 发布订阅模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Publish/Subscribe模式</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 使用交换机，将消息发给所有的绑定的队列</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 6:44 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublishSubscribeConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 没有参数的，表示临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs&quot;, type = &quot;fanout&quot;) // 交换机</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer1: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 没有参数的，表示临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs&quot;, type = &quot;fanout&quot;) // 交换机</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer2: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-4-Routing-路由模式（direct）"><a href="#5-2-4-Routing-路由模式（direct）" class="headerlink" title="5.2.4 Routing - 路由模式（direct）"></a>5.2.4 Routing - 路由模式（direct）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Routing 模式 - 消费者</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Exchange类型：direct</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 7:01 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs_direct&quot;, type = &quot;direct&quot;),</span></span><br><span class="line"><span class="meta">            key = &quot;info&quot; // routing key</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer1: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs_direct&quot;, type = &quot;direct&quot;),</span></span><br><span class="line"><span class="meta">            key = &#123;&quot;info&quot;, &quot;error&quot;, &quot;warning&quot;&#125; // routing key</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer2: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs_direct&quot;, type = &quot;direct&quot;),</span></span><br><span class="line"><span class="meta">            key = &#123;&quot;warning&quot;&#125;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive3</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer3: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-5-Topics-主题（动态路由）模式"><a href="#5-2-5-Topics-主题（动态路由）模式" class="headerlink" title="5.2.5 Topics - 主题（动态路由）模式"></a>5.2.5 Topics - 主题（动态路由）模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Topics模式 -消费者</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exchange的类型为：topic</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> secret</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/14 7:16 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicsConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs_topics&quot;, type = &quot;topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &#123;&quot;user.*&quot;&#125;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer1: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue, // 临时队列</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;logs_topics&quot;, type = &quot;topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &#123;&quot;user.#&quot;&#125;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer2: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-6-客户端测试代码"><a href="#5-2-6-客户端测试代码" class="headerlink" title="5.2.6 客户端测试代码"></a>5.2.6 客户端测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产端没有指定交换机，只有routing key和object。通过生产端的routing key和消费端的队列匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = RabbitMQApplication.class, webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直连模式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHelloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hello spring boot starter amqp...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// Work Queue模式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWorkQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;work&quot;</span>, <span class="string">&quot;hello work queue&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// Publish/Subscribe模式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPublishSubscribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;logs&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;hello publish subscribe &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// Routing模式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRouting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String routingKey = <span class="string">&quot;warning&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;logs_direct&quot;</span>, routingKey, <span class="string">&quot;hello routing, type=&quot;</span> + routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// Topics模式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTopics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String routingKey = <span class="string">&quot;user.save&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;logs_topics&quot;</span>, routingKey, <span class="string">&quot;hello topics, type=&quot;</span> + routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-MQ的应用场景"><a href="#6-MQ的应用场景" class="headerlink" title="6.MQ的应用场景"></a>6.MQ的应用场景</h2><h3 id="6-1-异步处理"><a href="#6-1-异步处理" class="headerlink" title="6.1 异步处理"></a>6.1 异步处理</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 场景说明：</span></span><br><span class="line"><span class="code">	用户注册后，需要发送邮件和注册短信，传统的做法有2种：1）串行方式 2）并行方式</span></span><br><span class="line"><span class="code">## 串行方式</span></span><br><span class="line"><span class="code">	将注册信息写入数据库后，再发送邮件，再注册短信，以上三个任务全部返回结果后，才返回给客户端。这里有一个问题，邮件、短信并不是必须的，它只是一个通知，而这种做法需要让客户端等待没有必要等待的东西。</span></span><br><span class="line"><span class="code">## 并行方式</span></span><br><span class="line"><span class="code">	将注册信息写入数据库后，发送邮件的同时，发送短信。以上三个任务完成后，返回给客户端，并行的方式能提高处理的效率。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/c0e203b0f649433984cbd50434586974.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<p><img src="https://img-blog.csdnimg.cn/17a5dbf434ee4c76a2745392fb70a774.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 消息队列：</span></span><br><span class="line"><span class="code">	除了以上提到的2种传统方式之外，我们还可以选择 消息队列 的形式。因为发送邮件和发送短信不是必须的，所以我们可以使用消息队列的形式，进行异步处理，相对于并行方式，减少了发送邮件或者短信的时间，相当于只有 注册信息写入数据库 + 写入消息队列 这个操作的耗时。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/c2bad0734fff4638acb0f0e7aa222327.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h3 id="6-2-应用解藕"><a href="#6-2-应用解藕" class="headerlink" title="6.2 应用解藕"></a>6.2 应用解藕</h3><p><img src="https://img-blog.csdnimg.cn/4096d6dc33ff48e380b3ec742e513b3c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 场景：</span></span><br><span class="line"><span class="code">	双十一是购物节，用户下单后，订单系统需要通知库存系统，传统做法是订单系统调用库存系统提供的接口。</span></span><br><span class="line"><span class="code"># 缺点：</span></span><br><span class="line"><span class="code">	这种做法有个缺点：当库存系统异常时，订单系统就无法使用。订单系统和库存系统就出现了耦合。解决方法引入消息队列。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/129b02a2439545ed8f748471c0f21b8a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 引入消息队列：</span></span><br><span class="line"><span class="code">	订单系统：用户下单后，订单系统完成持久化后，将消息写入 消息队列 ，返回用户下单成功。</span></span><br><span class="line"><span class="code">	库存系统：订阅下单消息，获取下单消息，进行库存操作。就算库存系统出现故障，消息队列也能保证消息的可靠投递，不会导致消息丢失。</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-流量削峰"><a href="#6-3-流量削峰" class="headerlink" title="6.3 流量削峰"></a>6.3 流量削峰</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 场景：</span></span><br><span class="line"><span class="code">	秒杀活动，一般会因为流量过大，导致应用挂掉。为了解决这个问题，一般在应用之前加入消息队列。</span></span><br><span class="line"><span class="code"># 作用：</span></span><br><span class="line"><span class="code">	1.可以控制活动人数，超过一定阈值的订单直接丢弃</span></span><br><span class="line"><span class="code">	2.可以缓解短时间的高流量压垮应用（程序按自己处理能力获取订单）。</span></span><br><span class="line"><span class="code"># 流程：</span></span><br><span class="line"><span class="code">	1.用户的请求，服务器收到之后先加入到消息队列。假如超过消息队列的最大长度，则直接丢弃用户请求或者跳转到错误页面。</span></span><br><span class="line"><span class="code">	2.秒杀业务根据消息队列中的请求信息，再做后续的处理。</span></span><br></pre></td></tr></table></figure>

<h2 id="7-RabbitMQ集群"><a href="#7-RabbitMQ集群" class="headerlink" title="7.RabbitMQ集群"></a>7.RabbitMQ集群</h2><h3 id="7-1-集群架构（副本集群）"><a href="#7-1-集群架构（副本集群）" class="headerlink" title="7.1 集群架构（副本集群）"></a>7.1 集群架构（副本集群）</h3><blockquote>
<p>默认情况下：RabbitMQ代理操作所需的所有数据/状态都将跨所有节点复制。这方面的一个例外是 消息队列，默认情况下，消息队列位于一个节点上，尽管他们可以从任意节点上看到和访问。–官网</p>
<p>也就是说，集群架构的方式只能在节点之间同步（复制）交换机等基本信息，无法同步队列信息。而队列信息是保存数据的地方，如果无法在节点之间进行复制，那么集群将失去一些意义。</p>
</blockquote>
<h4 id="7-1-1-架构图"><a href="#7-1-1-架构图" class="headerlink" title="7.1.1 架构图"></a>7.1.1 架构图</h4><p><img src="https://img-blog.csdnimg.cn/1b08e25a4092495f8412a4dd0801b780.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 核心解决问题：</span></span><br><span class="line"><span class="code">	当集群中某一时刻Master节点宕机，可以对Queue中信息进行备份。</span></span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-集群搭建"><a href="#7-1-2-集群搭建" class="headerlink" title="7.1.2 集群搭建"></a>7.1.2 集群搭建</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PS：使用docker安装</span><br><span class="line"><span class="section"># 0.集群规划</span></span><br><span class="line"><span class="code">	node1:  172.18.0.2 5672 15672 		master 主节点</span></span><br><span class="line"><span class="code">	node2:	172.18.0.3 5673 15673		repl1  副本节点</span></span><br><span class="line"><span class="code">	node3:	172.18.0.4 5674 15674	 	repl2  副本节点</span></span><br><span class="line"><span class="code"># 1.克隆三台主机名和ip映射，并修改各个虚拟机的hostname</span></span><br><span class="line"><span class="code">	创建网络：</span></span><br><span class="line"><span class="code">		docker network create rabbit-net</span></span><br><span class="line"><span class="code">	创建容器：</span></span><br><span class="line"><span class="code">		docker run -d --privileged=true --hostname node1 --name node1 -p 15672:15672 -p 5672:5672 --network rabbit-net centos:8.2.2004 /sbin/init</span></span><br><span class="line"><span class="code">	进入容器：</span></span><br><span class="line"><span class="code">		docker exec -it node/node1/node2 /bin/bash</span></span><br><span class="line"><span class="code">	复制erlang、rabbit的rpm包到容器：</span></span><br><span class="line"><span class="code">		docker cp ./erlang.xxx.rpm node1:/</span></span><br><span class="line"><span class="code">		docker cp ./rabbitmq.xxx.rpm node1:/</span></span><br><span class="line"><span class="code">	安装：</span></span><br><span class="line"><span class="code">		rpm -ihv erlang.xxx.rpm</span></span><br><span class="line"><span class="code">		rpm -ivh rabbitmq.xxx.rpm --nodeps --force</span></span><br><span class="line"><span class="code">	配置：</span></span><br><span class="line"><span class="code">		在/etc/hosts加入各个节点的ip和域名对应关系。</span></span><br><span class="line"><span class="code">	问题：</span></span><br><span class="line"><span class="code">		参考：https://blog.csdn.net/weixin_42181917/article/details/105579288</span></span><br><span class="line"><span class="code">		1.System has not been booted with systemd as init system (PID 1). Can&#x27;t operate.Failed to create bus connection: Host is down</span></span><br><span class="line"><span class="code">		解决：创建容器使用 /sbin/init</span></span><br><span class="line"><span class="code">		2.Could not set property: Failed to set static hostname: Device or resource busy</span></span><br><span class="line"><span class="code">		解决：退出容器，重新进入在设置一次</span></span><br><span class="line"><span class="code">			hostnamectl set-hostname node/node1/node2</span></span><br><span class="line"><span class="code">			exit</span></span><br><span class="line"><span class="code">			hostnamectl set-hostname node/node1/node2</span></span><br><span class="line"><span class="code"># 2.三台机器安装rabbitmq，并同步cookie文件</span></span><br><span class="line"><span class="code">	docker cp 命令将宿主机中的erlang和rabbitmq的rpm包都上传到虚拟机中，启动rabbitmq。</span></span><br><span class="line"><span class="code">	docker cp 命令将node1节点中的 /var/lib/rabbitmq/.erlang.cookie文件复制到宿主机，再通过宿主机复制到node1和node2.</span></span><br><span class="line"><span class="code">	这里需要注意看是否.erlang.cookie文件的权限是否和node相同：chown、chgrp 命令可以修改权限。</span></span><br><span class="line"><span class="code"># 3.查看cookie文件是否一致</span></span><br><span class="line"><span class="code">	进入三个节点的虚拟机中，执行: cat /var/lib/rabbitmq/.erlang.cookie，查看内容是否一致。</span></span><br><span class="line"><span class="code"># 4.后台启动rabbit</span></span><br><span class="line"><span class="code">	rabbitmq-server -detached</span></span><br><span class="line"><span class="code"># 5.在node2和node3执行加入集群命令</span></span><br><span class="line"><span class="code">	1.关闭		rabbitmqctl stop_app</span></span><br><span class="line"><span class="code">	2.加入集群	   rabbitmqctl join_cluster rabbit@node</span></span><br><span class="line"><span class="code">	3.启动服务	   rabbitmqctl start_app</span></span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><strong>搭建成功：</strong></p>
<p><img src="https://img-blog.csdnimg.cn/4e5b989ee58b4a63816087ee87cb34d4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<p><img src="https://img-blog.csdnimg.cn/c9e21a1431b74730908aefb32fdc5cbe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h3 id="7-2-镜像集群"><a href="#7-2-镜像集群" class="headerlink" title="7.2 镜像集群"></a>7.2 镜像集群</h3><blockquote>
<p>镜像队列机制就是将队列在三个节点之间设置主从关系，消息会在三个节点之间自动进行同步。且如果其中一个节点不可用，并不会导致消息丢失或者服务不可用的情况，提升MQ集群整体的高可用性。–摘自官网</p>
</blockquote>
<h4 id="7-2-1-架构图"><a href="#7-2-1-架构图" class="headerlink" title="7.2.1 架构图"></a>7.2.1 架构图</h4><p><img src="https://img-blog.csdnimg.cn/677182699180463baa2a64e582a7042c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<h4 id="7-2-2-集群搭建"><a href="#7-2-2-集群搭建" class="headerlink" title="7.2.2 集群搭建"></a>7.2.2 集群搭建</h4><p>​        镜像集群的搭建，是在<code>副本集群</code>的基础之上做的额外配置，也就是说必选先搭建好<code>副本集群</code>才能搭建镜像集群。这个额外配置就是需要创建一个<code>策略</code>。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 0.策略说明</span></span><br><span class="line"><span class="code">	rabbitmqctl set_policy [--vhost &lt;vhost&gt;] [--priority &lt;priority&gt;] [--apply-to &lt;apply-to&gt;] &lt;name&gt; &lt;pattern&gt; &lt;definition&gt;</span></span><br><span class="line"><span class="code">	--vhost：可选参数，针对指定virutal host下的queue进行设置</span></span><br><span class="line"><span class="code">	--priority：可选参数，policy的优先级，越大越优先</span></span><br><span class="line"><span class="code">	--appliy-to：可选参数，表示策略应用的对象，后面跟queues|exchanges|all。</span></span><br><span class="line"><span class="code">	name：策略名称，唯一标识。</span></span><br><span class="line"><span class="code">	pattern：匹配队列的正则表达式。</span></span><br><span class="line"><span class="code">	definition：镜像定义，包括三个部分：ha-mode、ha-params、ha-sync-mode</span></span><br><span class="line"><span class="code">		ha-mode：镜像队列模式，可选值：all/exaclty/nodes</span></span><br><span class="line"><span class="code">			all：表示在集群的所有节点上进行镜像</span></span><br><span class="line"><span class="code">			exactly：表示在指定个数的节点上进行镜像，节点个数通过ha-params指定</span></span><br><span class="line"><span class="code">			nodes：表示在指定节点上进行镜像，节点名称通过ha-params指定</span></span><br><span class="line"><span class="code">		ha-params：ha-mode需要用到的参数</span></span><br><span class="line"><span class="code">		ha-sync-mode：队列同步方式，可选值为：automatic/manual</span></span><br><span class="line"><span class="code">			automatic：自动同步</span></span><br><span class="line"><span class="code">			manual：用户触发同步</span></span><br><span class="line"><span class="code"># 1.查看当前策略</span></span><br><span class="line"><span class="code">	rabbitmqctl list_policies</span></span><br><span class="line"><span class="code"># 2.添加策略</span></span><br><span class="line"><span class="code">	rabbitmqctl set_policy ha-all &#x27;^hello&#x27; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;,&quot;ha-sync-mode&quot;:&quot;automatic&quot;&#125;&#x27;</span></span><br><span class="line"><span class="code">	说明：策略正则表示为&quot;^&quot;表示匹配所有队列，&quot;^hello&quot;表示匹配hello开头的队列</span></span><br><span class="line"><span class="code"># 3.删除策略</span></span><br><span class="line"><span class="code">	rabbitmqctl clear_policy ha-all</span></span><br></pre></td></tr></table></figure>

<p><strong>搭建成功：</strong></p>
<p><img src="https://img-blog.csdnimg.cn/0a123778671941e99aac309f1180c599.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
<p><img src="https://img-blog.csdnimg.cn/4c70637a590c4150b0f2296b65bc3837.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARE1ha2VyMTk5Mw==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="image"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">secret</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dmaker1993.gibhub.io/2021/12/23/RabbitMQ基础与集群实战/">https://dmaker1993.gibhub.io/2021/12/23/RabbitMQ基础与集群实战/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dmaker1993.gibhub.io">一名不愿透露姓名的程序员</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RabbitMQ/">RabbitMQ</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="post-meta__tags" href="/tags/%E9%9B%86%E7%BE%A4/">集群</a></div><nav id="pagination"></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2021 By secret</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>